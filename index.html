<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Keep Walking">
<meta property="og:type" content="website">
<meta property="og:title" content="NgWaiKong&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="NgWaiKong&#39;s Blog">
<meta property="og:description" content="Keep Walking">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NgWaiKong&#39;s Blog">
<meta name="twitter:description" content="Keep Walking">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>NgWaiKong's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">NgWaiKong's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Keep Walking</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/02/流信息监控/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="NgWaiKong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NgWaiKong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/02/流信息监控/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T15:18:09+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="流直播卡顿监控"><a href="#流直播卡顿监控" class="headerlink" title="流直播卡顿监控"></a>流直播卡顿监控</h2><h3 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h3><p>流直播业务中多场大型直播（蔡徐坤、TFBOYS）出现用户投诉直播画面卡顿问题，但客户端在直播时无法更快更直接定位问题，因此针对已知问题增加debug页面，输出关键信息，方便快速响应。</p>
<h3 id="二、问题汇总"><a href="#二、问题汇总" class="headerlink" title="二、问题汇总"></a>二、问题汇总</h3><p>在当前业务中，直播视频数据流程是如下：</p>
<ul>
<li>①直播现场麦克风、摄像头进行音视频数据采集，上传后台</li>
<li>②后台进行编码和封装成HLS（进行TS切片和M3U8更新）</li>
<li>③后台分发到各CDN</li>
<li>④客户端定时请求M3U8文件，并进行播放</li>
</ul>
<p>因此结合音视频理论和多次直播实践，总结出以后可能会碰到的问题：</p>
<ol>
<li>流信息异常（流程①、②出错）</li>
<li>后台（上游）编码缓慢（流程②耗时长）</li>
<li>数据请求失败（流程③后台、运维出错；流程④客户端请求逻辑出错）</li>
<li>播放器读取数据不及时（流程④客户端网络问题）</li>
<li>播放器音画不同步（流程④客户端性能问题）</li>
</ol>
<h3 id="三、问题监控"><a href="#三、问题监控" class="headerlink" title="三、问题监控"></a>三、问题监控</h3><p>针对上述问题，在直播页面增加了debug页面，对关键信息输出：</p>
<p><img src="http://m.qpic.cn/psb?/V10Sw18W02Zr0F/FDX0M.jeHIq*e700un48k1fvVGNoYsN2QDIB3noSlkk!/b/dDYBAAAAAAAA&amp;bo=gAc4BAAAAAADV8k!&amp;rf=viewer_4&amp;t=5" alt=""></p>
<ul>
<li><p>当前音视频AVPacket的pts信息（监控问题1）</p>
</li>
<li><p>当前M3U8请求包、M3U8内容信息（监控问题2）</p>
</li>
<li>当前ts分片请求包信息（监控问题3）</li>
<li>播放器音视频读取AVPacket的时间戳、AVFrame解码前后、当前展示帧的对应时间戳；当前解码帧率；（监控问题4、5）</li>
</ul>
<h3 id="四、监控原理"><a href="#四、监控原理" class="headerlink" title="四、监控原理"></a>四、监控原理</h3><h4 id="（一）流信息异常"><a href="#（一）流信息异常" class="headerlink" title="（一）流信息异常"></a>（一）流信息异常</h4><ul>
<li>播放器根据码流中的音视频的pts来做渲染以及音画同步</li>
<li>若码流中的音视频时间戳出现错误，会影响到播放画面的渲染时机。</li>
</ul>
<p><img src="http://m.qpic.cn/psb?/V10Sw18W02Zr0F/wXvIbeJYogPE9qDD4FrVE765tAFdlMLkC8CIpDLMsYM!/b/dDQBAAAAAAAA&amp;bo=0AJxAQAAAAARF4I!&amp;rf=viewer_4&amp;t=5" alt=""></p>
<p>以上述为例，该流的视频pts时间戳在部分时间内出现了数据量较大的“倒退”。播放器会进行丢帧等待或强制渲染导致跳帧。</p>
<p>针对该问题，记录了流中音视频每一个<strong>AVPacket的pts时间戳</strong></p>
<p>通过观察该时间戳是否<strong>在递增来判断流是否异常</strong>。</p>
<h4 id="（二）、后台（上游）编码缓慢"><a href="#（二）、后台（上游）编码缓慢" class="headerlink" title="（二）、后台（上游）编码缓慢"></a>（二）、后台（上游）编码缓慢</h4><ol>
<li>后台在直播过程中会持续编码，在编码出新的TS分片后，会更新M3U8文件，返回最新的N个TS分片地址。</li>
<li>客户端会定期请求最新的M3U8文件，拿到最新的TS分片地址进行播放。</li>
<li>若后台编码或分发TS分片缓慢，会导致客户端无法请求到最新数据而进而loading等待（发生二次缓冲）</li>
</ol>
<p>针对该问题，记录了<strong>每次后台返回M3U8文件的内容</strong>：</p>
<ul>
<li>EXT-X-MEDIA-SEQUENCE 是否在合理时间内正常递增</li>
<li>EXTINF 以及 TS分片地址 是否在合理时间内正常更新</li>
</ul>
<p>通过<strong>比对前后M3U8内容来监控后台编码进度</strong>。</p>
<h4 id="（三）、数据请求失败"><a href="#（三）、数据请求失败" class="headerlink" title="（三）、数据请求失败"></a>（三）、数据请求失败</h4><ol>
<li>在直播过程中，后台需要一直编码生成TS分片。为了减少成本，后台会维持一个TS分片的缓存池，若TS分片时间太旧则会淘汰删除。</li>
<li>若后台最新的M3U8中带有已经删除的TS分片，或客户端因逻辑问题请求了旧的TS分片，则会有HTTP 404问题。</li>
</ol>
<p>针对该问题，记录了<strong>客户端每次请求TS分片的信息</strong>：</p>
<ul>
<li>请求时间点</li>
<li>响应头信息（code、header error）</li>
</ul>
<p>通过对比<strong>TS分片的请求信息</strong>来定位后台TS存储（404）问题。</p>
<h4 id="（四）、播放器读取数据不及时、音画不同步"><a href="#（四）、播放器读取数据不及时、音画不同步" class="headerlink" title="（四）、播放器读取数据不及时、音画不同步"></a>（四）、播放器读取数据不及时、音画不同步</h4><ol>
<li>客户端会对流信息数据进行解协议、解封装和解码，经过音画同步模块处理后渲染上屏。</li>
<li>若客户端网络情况恶劣，数据读取不及时，会导致发生二次缓冲。</li>
<li>若客户端CPU性能不足，解码需要耗时过长时，会导致音画不同步或丢帧跳帧。 </li>
</ol>
<p>针对以上问题，记录了客户端<strong>音视频当前解封装、解码、渲染的帧时间戳</strong>：</p>
<ul>
<li>发生二次缓冲时，比较当前音频解封装数据和解码数据，可以定位播放器数据读取情况</li>
<li><p>比较当前音频展示帧pts和视频展示帧pts，可以得到音画不同步的程度</p>
</li>
<li><p>比较音视频解封装数据和解码数据时间戳可以量化出音视频解码性能</p>
</li>
<li>计算音视频单位时间内展示的帧数，来量化出音视频流的当前FPS</li>
</ul>
<p>通过以上数据，<strong>实时监控到播放器当前请求、解码数据量以及音画不同步的程度</strong>，来帮助判断用户当前<strong>网络环境、CPU性能</strong>对卡顿的影响。</p>
<h3 id="五、附录："><a href="#五、附录：" class="headerlink" title="五、附录："></a>五、附录：</h3><h4 id="（一）DTS和PTS（IBP帧、GOP）"><a href="#（一）DTS和PTS（IBP帧、GOP）" class="headerlink" title="（一）DTS和PTS（IBP帧、GOP）"></a>（一）DTS和PTS（IBP帧、GOP）</h4><h5 id="1、PTS和DTS"><a href="#1、PTS和DTS" class="headerlink" title="1、PTS和DTS"></a>1、PTS和DTS</h5><ul>
<li>DTS：Decoding Time Stamp，用于解码</li>
<li>PTS：Presentation Time Stamp，用于输出</li>
</ul>
<p>在没有B帧的情况下，DTS和PTS输出顺序是一样的，但是大多数的编码标准码（H.264的编码顺序和输入顺序是不一致）B帧会打乱了解码和显示的顺序。</p>
<p>FFmpeg中，会使用AVPacket结构来描述解码前（和编码后）的压缩数据，用AVFrame来描述解码后的原始数据。AVFrame就是视频的一帧图像，通过它的PTS来决定什么时候显示。AVPacket的DTS代表需要在什么时候解码。</p>
<h5 id="2、GOP"><a href="#2、GOP" class="headerlink" title="2、GOP"></a>2、GOP</h5><ul>
<li>I帧：自身可以通过视频解压算法解压成一张单独的完整的图片。</li>
<li>P帧：需要参考其前面的一个I帧或者B帧来生成一张完整的图片。</li>
<li>B帧：则要参考其前一个I或者P帧及其后面的一个P帧来生成一张完整的图片。</li>
<li>GOP：两个I帧之间形成的一组图片。其中编码参数gop_size代表的是两个I帧之间的帧数目。必须从I帧开始解码。</li>
</ul>
<p>一个GOP中容量最大的帧是I帧，gop_size越大，质量越高。</p>
<p>PS：在提供视频质量的技术中，其中一个是多使用B帧，因为I帧的压缩率是7，P是20，B可以到50，使用B帧能大量的空间，节省出来的空间可以用来更多地保存I帧，这样子就能在相同码率下提供更好的画质。</p>
<h5 id="3、结合"><a href="#3、结合" class="headerlink" title="3、结合"></a>3、结合</h5><p><img src="http://m.qpic.cn/psb?/V10Sw18W02Zr0F/f3s3k0Za5OSVsG0McdP4kVSQTDGmot9Vjlpza*dpOPQ!/b/dDQBAAAAAAAA&amp;bo=PQLMAAAAAAARF9M!&amp;rf=viewer_4&amp;t=5" alt=""></p>
<h4 id="（二）直播M3U8文件"><a href="#（二）直播M3U8文件" class="headerlink" title="（二）直播M3U8文件"></a>（二）直播M3U8文件</h4><h5 id="1、直播HLS实现"><a href="#1、直播HLS实现" class="headerlink" title="1、直播HLS实现"></a>1、直播HLS实现</h5><p><strong>本质：以HLS点播方式实现了直播</strong></p>
<ul>
<li>HLS协议在服务器端将直播数据流存储为TS分片文件，并会将最新的直播数据生成新的TS分片</li>
<li>客户端则只要不停地按顺序下载和播放请求返回的最新的TS文件，就能实现直播</li>
</ul>
<h5 id="2、直播M3U8区别"><a href="#2、直播M3U8区别" class="headerlink" title="2、直播M3U8区别"></a>2、直播M3U8区别</h5><p>直播M3U8中</p>
<ul>
<li>没有EXT-X-ENDLIST标签，因为实时流不会有结束。</li>
<li>返回最新的TS分片地址，会有TS分片个数限制</li>
</ul>
<h5 id="3、细节"><a href="#3、细节" class="headerlink" title="3、细节"></a>3、细节</h5><h6 id="（1）后台："><a href="#（1）后台：" class="headerlink" title="（1）后台："></a>（1）后台：</h6><ul>
<li>不断更新TS内容和EXT-X-MEDIA-SEQUENCE标签，以步长为1进行递增（类似滑动窗口）</li>
<li>在更新M3U8时每个TS信息和播放时长在更新前后保持一致</li>
<li>为了减少成本，仅存储最近一段时间内的TS分片，淘汰删除较老旧的</li>
</ul>
<p>PS：业界新方案：不将TS切片文件存到磁盘，而是存在内存当中。（这种技术使得服务器的磁盘上面不再会有“数以吨计”的文件碎片，极大减少了磁盘的I/O次数，延长了服务器磁盘的使用寿命，极大提高了服务器运行的稳定性。也使得终端请求数据时直接从服务器的内存中获取，极大提高了对终端数据请求的反应速度，优化了视频观看体验。）</p>
<h6 id="（2）客户端："><a href="#（2）客户端：" class="headerlink" title="（2）客户端："></a>（2）客户端：</h6><ul>
<li><p>解析到M3U8中没有EXT-X-ENDLIST标签，会触发定时请求逻辑，并设置定时请求的间隔。</p>
</li>
<li><p>定期请求M3U8的间隔：首次以#EXT-X-TARGETDURATION作为间隔，后续以最后一个TS分片的播放时长作为间隔。（不同播放器请求策略也有所不同）</p>
</li>
</ul>
<h6 id="（3）M3U8示例："><a href="#（3）M3U8示例：" class="headerlink" title="（3）M3U8示例："></a>（3）M3U8示例：</h6><p>时间：19:56:31，<strong>分片信息为12024_shuping-1535457300到12024_shuping-1535457304</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-ALLOW-CACHE:NO</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:1535457300</span><br><span class="line">#EXT-X-TARGETDURATION:11</span><br><span class="line">#EXTINF:5.920,</span><br><span class="line">12024_shuping-1535457300.ts</span><br><span class="line">#EXTINF:7.320,</span><br><span class="line">12024_shuping-1535457301.ts</span><br><span class="line">#EXTINF:10.600,</span><br><span class="line">12024_shuping-1535457302.ts</span><br><span class="line">#EXTINF:5.480,</span><br><span class="line">12024_shuping-1535457303.ts</span><br><span class="line">#EXTINF:5.0,</span><br><span class="line">12024_shuping-1535457304.ts</span><br></pre></td></tr></table></figure>
<p>时间：19:56:40，<strong>分片信息为12024_shuping-1535457302到12024_shuping-1535457306</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-ALLOW-CACHE:NO</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:1535457302</span><br><span class="line">#EXT-X-TARGETDURATION:11</span><br><span class="line">#EXTINF:10.600,</span><br><span class="line">12024_shuping-1535457302.ts</span><br><span class="line">#EXTINF:5.480,</span><br><span class="line">12024_shuping-1535457303.ts</span><br><span class="line">#EXTINF:5.0,</span><br><span class="line">12024_shuping-1535457304.ts</span><br><span class="line">#EXTINF:5.120,</span><br><span class="line">12024_shuping-1535457305.ts</span><br><span class="line">#EXTINF:5.400,</span><br><span class="line">12024_shuping-1535457306.ts</span><br></pre></td></tr></table></figure>
<p>相当于滑动了2个TS位置。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/04/QQ音乐MV播放杂音问题跟进/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="NgWaiKong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NgWaiKong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/04/QQ音乐MV播放杂音问题跟进/" itemprop="url">QQ音乐MV播放杂音问题跟进</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-04T00:00:00+08:00">
                2018-08-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/performance/" itemprop="url" rel="index">
                    <span itemprop="name">performance</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="QQ音乐MV播放杂音问题跟进"><a href="#QQ音乐MV播放杂音问题跟进" class="headerlink" title="QQ音乐MV播放杂音问题跟进"></a>QQ音乐MV播放杂音问题跟进</h1><h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>QQ音乐Android端播放MV视频《凤凰花开的路口》时带有如电流声一般的杂音，影响用户的正常体验。</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>在初步定位中，发现有如下特征：</p>
<ul>
<li>Android端杂音问题必现</li>
<li>iOS、PC端能正常播放《凤凰花开的路口》，没有噪音（各端都是统一用hls格式播放）</li>
</ul>
<p>对于该问题，定位思路如下：</p>
<ul>
<li>梳理ijkplayer流程</li>
<li>找到切入点排查</li>
</ul>
<h3 id="（一）ijkplayer流程"><a href="#（一）ijkplayer流程" class="headerlink" title="（一）ijkplayer流程"></a>（一）ijkplayer流程</h3><p><img src="http://m.qpic.cn/psb?/V10Sw18W4gWqgb/VPf.VLzaJABzmhSeVM5a60btIqrZoSgFY1QyVkiZDUc!/b/dDEBAAAAAAAA&amp;bo=uATVAgAAAAADF1k!&amp;rf=viewer_4&amp;t=5" alt=""></p>
<p>结合上图，总结关键步骤（图中内容从左往右，以音频解码播放为例）：<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/08/04/QQ音乐MV播放杂音问题跟进/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/01/日本關西遊記/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="NgWaiKong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NgWaiKong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/01/日本關西遊記/" itemprop="url">日本關西遊記</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-01T00:00:00+08:00">
                2018-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="日本關西隨筆"><a href="#日本關西隨筆" class="headerlink" title="日本關西隨筆"></a>日本關西隨筆</h1><p>6月底到日本關西團建，記錄一些見聞和心情</p>
<h2 id="一、目標"><a href="#一、目標" class="headerlink" title="一、目標"></a>一、目標</h2><p>此行出遊日本目標為Team Building，但對於我個人來說：</p>
<ul>
<li>脫離工作</li>
<li>增廣見聞</li>
<li>購物</li>
</ul>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/07/01/日本關西遊記/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/28/CpuDumper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="NgWaiKong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NgWaiKong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/28/CpuDumper/" itemprop="url">Android获取CPU使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-28T00:00:00+08:00">
                2018-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/performance/" itemprop="url" rel="index">
                    <span itemprop="name">performance</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="获取CPU情况方法"><a href="#获取CPU情况方法" class="headerlink" title="获取CPU情况方法"></a>获取CPU情况方法</h1><p>CPU是性能优化其中一环，对常规的CPU收集手段整理并进行沉淀。<br>代码：<a href="https://github.com/NgWaiKong/CpuDumper" target="_blank" rel="noopener">CpuDumper</a></p>
<h2 id="一、CPU占用"><a href="#一、CPU占用" class="headerlink" title="一、CPU占用"></a>一、CPU占用</h2><h3 id="1、proc-stat"><a href="#1、proc-stat" class="headerlink" title="1、proc/stat"></a>1、proc/stat</h3><ul>
<li>proc/stat节点记录的是系统进程整体CPU的统计信息</li>
<li>文件中的时间单位，sysconf(_SC_CLK_TCK)一般地定义为jiffies(一般地等于10ms)</li>
<li>总的cpu时间 = 前七个变量（user, nice, system, idle, iowait, irq, softirq）之和</li>
<li>上述时间为一个累计时间，需要在两个时间点分别读一下cpu快照，设为total_time_old 和 total_time_new，则两个值相减即为这段时间内的总CPU时间total_time_delta，然后想办法读一个进程或线程在相同时间段内的cpu时间proc_time_delta, 则该进程或线程的cpu使用率即为（ proc_time_delta / total_time_delta ）* 100% </li>
<li>项目代码：CpuDumper.dumpSystemRate</li>
</ul>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/05/28/CpuDumper/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/23/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="NgWaiKong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NgWaiKong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/23/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-23T12:48:17+08:00">
                2018-04-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post.</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/04/23/hello-world/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/22/StateMachine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="NgWaiKong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NgWaiKong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/22/StateMachine/" itemprop="url">Android StateMachine分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-22T00:00:00+08:00">
                2018-04-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/architecture/" itemprop="url" rel="index">
                    <span itemprop="name">architecture</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="Android-StateMachine分析"><a href="#Android-StateMachine分析" class="headerlink" title="Android StateMachine分析"></a>Android StateMachine分析</h1><h2 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>例子：按钮控制电梯状态：电梯有开门、关门、运行、停止、上升、下降、选择楼层等状态。每种状态改变，都有可能根据其他状态来更新处理，如在上升中不能开门。在实际编码中，考虑遍历完各种情况状态，需要引入大量的if…else if 或者 switch case，对可读性、维护性、扩展性带来挑战。</li>
<li>问题：对象如何在每一种状态下表现出不同的行为？</li>
<li>解决：状态模式：允许一个对象在其内部状态改变时改变它的行为。对象看起来似乎修改了它的类。（第一句话解释：行为会随内部变化而变化，如在电梯停止和上升时，点击选择，将会得到不一样的行为。第二句话解释：从外部角度来看，如果使用的对象能够完全改变它的行为，那么这个对象会是其他类的实例化。但实际上它只是引用了不同状态对象来造成类改变假象）</li>
<li>适用：一个对象的行为取决于它的状态；代码中包含大量与对象状态有关的条件语句。</li>
<li>优缺点：优点：通过将特定状态相关的行为局部化，并且将不同状态的行为分割开来来实现解耦；使得状态转换显式化。缺点：增加系统类和对象的个数，实现都较为复杂，如果使用不当将导致程序结构和代码的混乱。</li>
<li>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/04/22/StateMachine/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/21/MVI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="NgWaiKong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NgWaiKong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/21/MVI/" itemprop="url">Thinking in MVI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-21T00:00:00+08:00">
                2018-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/architecture/" itemprop="url" rel="index">
                    <span itemprop="name">architecture</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="一、业务问题"><a href="#一、业务问题" class="headerlink" title="一、业务问题"></a>一、业务问题</h2><p>个人负责维护过的几个业务，都以MVC、MVP模式来设计。随着业务发展，出现以下问题：</p>
<ul>
<li>改动一处Model牵连数处View，难以测试</li>
<li>View的更新时序不一，难以调试</li>
<li>View、Model调用源头过多，难以跟踪</li>
</ul>
<h2 id="二、问题分析"><a href="#二、问题分析" class="headerlink" title="二、问题分析"></a>二、问题分析</h2><p>对整体业务进行了熟悉和梳理后，发现架构情况（单以MVC为例）如图：</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/03/21/MVI/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">NgWaiKong</p>
              <p class="site-description motion-element" itemprop="description">Keep Walking</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ngwaikong" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/ngwaikong/" target="_blank" title="Zhihu">
                      
                        <i class="fa fa-fw fa-zhihu"></i>Zhihu</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NgWaiKong</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
